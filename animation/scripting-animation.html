<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
    <title>使用脚本控制动画</title>
    <link type="text/css" rel="stylesheet" href="../assets/css/github-markdown.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/pilcrow.css">
    <link type="text/css" rel="stylesheet" href="../assets/css/hljs-github.min.css"/>
    <link type="text/css" rel="stylesheet" href="../assets/css/style.css"/>
    <link rel="shortcut icon" type="image/ico" href="../assets/favicon.ico">
  </head>
  <body>
  <div class="full-wrap">
    <div class="sidebar markdown-body">
      <div class="inner">
        <div class="logo">
          <a href="../index.html"><img src="../assets/img/logo.png"></a>
        </div>
        <ul class="nav nav-list">
          <li class="sidebar-header-1 "><h3><a href="../getting-started/index.html">Cocos Creator 入门</a></h3></li>
          <li class=" sidebar-header-3"><a href="../getting-started/introduction.html">关于 Cocos Creator</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/install.html">安装和启动</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/dashboard.html">使用 Dashboard</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/hello-world.html">Hello World!</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/quick-start.html">快速上手: 制作第一个游戏</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/cocos2d-x-guide.html">Cocos2d-x 用户上手指南</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/unity-guide.html">Unity 用户上手指南</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/project-structure.html">项目结构</a></li>
          <li class=" sidebar-header-3"><a href="../getting-started/support.html">获取帮助和支持</a></li>
          <li class="sidebar-header-1 "><h3><a href="../basics/index.html">编辑器基础</a></h3></li>
          <li class=" sidebar-header-3"><a href="../basics/editor-overview.html">编辑器界面介绍</a></li>
          <li class=" sidebar-header-4"><a href="../basics/editor-panels/assets.html">资源管理器</a></li>
          <li class=" sidebar-header-4"><a href="../basics/editor-panels/scene.html">场景编辑器</a></li>
          <li class=" sidebar-header-4"><a href="../basics/editor-panels/hierarchy.html">层级管理器</a></li>
          <li class=" sidebar-header-4"><a href="../basics/editor-panels/inspector.html">属性检查器</a></li>
          <li class=" sidebar-header-4"><a href="../basics/editor-panels/console.html">控制台</a></li>
          <li class=" sidebar-header-3"><a href="../basics/toolbar.html">工具栏</a></li>
          <li class=" sidebar-header-3"><a href="../basics/layout.html">编辑器布局</a></li>
          <li class="sidebar-header-1 "><h3><a href="../asset-workflow/index.html">资源工作流程</a></h3></li>
          <li class=" sidebar-header-3"><a href="../asset-workflow/scene-managing.html">创建和管理场景</a></li>
          <li class=" sidebar-header-3"><a href="../asset-workflow/sprite.html">图像资源（Texture）</a></li>
          <li class=" sidebar-header-3"><a href="../asset-workflow/atlas.html">图集资源（Atlas）</a></li>
          <li class=" sidebar-header-3"><a href="../asset-workflow/font.html">字体资源</a></li>
          <li class=" sidebar-header-3"><a href="../asset-workflow/particle.html">粒子资源</a></li>
          <li class=" sidebar-header-3"><a href="../asset-workflow/audio-asset.html">声音资源（AudioClip）</a></li>
          <li class=" sidebar-header-3"><a href="../asset-workflow/prefab.html">预制资源（Prefab）</a></li>
          <li class="sidebar-header-1 "><h3><a href="../content-workflow/index.html">内容创作工作流程</a></h3></li>
          <li class=" sidebar-header-3"><a href="../content-workflow/node-component.html">节点和组件</a></li>
          <li class=" sidebar-header-3"><a href="../content-workflow/transform.html">坐标系和变换</a></li>
          <li class=" sidebar-header-3"><a href="../content-workflow/node-tree.html">管理节点层级和显示顺序</a></li>
          <li class=" sidebar-header-3"><a href="../content-workflow/scene-editing.html">使用场景编辑器搭建场景图像</a></li>
          <li class="sidebar-header-1 "><h3><a href="../ui/index.html">UI 系统</a></h3></li>
          <li class=" sidebar-header-3"><a href="../ui/sliced-sprite.html">使用 Sliced Sprite 制作 UI 图像</a></li>
          <li class=" sidebar-header-3"><a href="../ui/multi-resolution.html">多分辨率适配方案</a></li>
          <li class=" sidebar-header-3"><a href="../ui/widget-align.html">对齐策略</a></li>
          <li class=" sidebar-header-3"><a href="../ui/label-layout.html">文字排版</a></li>
          <li class=" sidebar-header-3"><a href="../ui/ui-components.html">常用 UI 控件</a></li>
          <li class=" sidebar-header-3"><a href="../ui/auto-layout.html">自动布局容器</a></li>
          <li class=" sidebar-header-3"><a href="../ui/list-with-data.html">制作动态生成内容的列表</a></li>
          <li class="sidebar-header-1 "><h3><a href="index.html">动画系统</a></h3></li>
          <li class=" sidebar-header-3"><a href="animation.html">关于 Animation</a></li>
          <li class=" sidebar-header-3"><a href="animation-clip.html">创建 Animation 组件和动画剪辑</a></li>
          <li class=" sidebar-header-3"><a href="animation-curve.html">编辑动画曲线</a></li>
          <li class=" sidebar-header-3"><a href="sprite-animation.html">编辑序列帧动画</a></li>
          <li class=" sidebar-header-3"><a href="time-curve.html">编辑时间曲线</a></li>
          <li class=" sidebar-header-3"><a href="animation-event.html">添加动画事件</a></li>
          <li class="active sidebar-header-3"><a href="scripting-animation.html">使用脚本控制动画</a></li>
          <li class="sidebar-header-1 "><h3><a href="../components/index.html">组件参考</a></h3></li>
          <li class=" sidebar-header-3"><a href="../components/sprite.html">Sprite 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/label.html">Label 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/animation.html">Animation 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/canvas.html">Canvas 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/widget.html">Widget 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/progress.html">ProgressBar 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/button.html">Button 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/mask.html">Mask 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/scrollview.html">ScrollView 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/scrollbar.html">ScrollBar 组件参考</a></li>
          <li class=" sidebar-header-3"><a href="../components/layout.html">Layout 组件参考</a></li>
          <li class="sidebar-header-1 "><h3><a href="../scripting/index.html">脚本开发工作流程</a></h3></li>
          <li class=" sidebar-header-3"><a href="../scripting/use-component.html">创建和使用组件脚本</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/properties.html">声明属性</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/access-node-component.html">访问节点和其他组件</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/life-cycle-callbacks.html">生命周期回调</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/create-destroy.html">创建和销毁节点</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/events.html">发射和监听事件</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/internal-events.html">系统内置事件</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/actions.html">使用动作系统</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/action-list.html">动作列表</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/scheduler.html">使用计时器</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/execution-order.html">脚本执行顺序</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/pooling.html">使用对象池</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/load-assets.html">获取资源</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/modular-script.html">模块化脚本</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/web-debug-scripts.html">在浏览器中调试脚本</a></li>
          <li class=" sidebar-header-3"><a href="../scripting/javascript-primer.html">JavaScript 快速入门</a></li>
          <li class=" sidebar-header-4"><a href="../scripting/reference/attributes.html">属性参数参考</a></li>
          <li class="sidebar-header-1 "><h3><a href="../publish/index.html">跨平台发布游戏</a></h3></li>
          <li class=" sidebar-header-3"><a href="../publish/publish-web.html">发布到 Web 平台</a></li>
          <li class=" sidebar-header-3"><a href="../publish/cocos-framework.html">安装配置 Cocos Framework</a></li>
          <li class=" sidebar-header-3"><a href="../publish/publish-native.html">打包发布原生平台</a></li>
        </ul>
      </div>
    </div>
    <div class="main">
      <article class="markdown-body"><h1 id="-">使用脚本控制动画</h1>
<h2 id="animation-">Animation 组件</h2>
<p>Animation 组件提供了一些常用的动画控制函数，如果只是需要简单的控制动画，可以通过获取节点的 Animation 组件来做一些操作。</p>
<h3 id="--1">播放</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);

<span class="hljs-comment">// 如果没有指定播放哪个动画，并且有设置 defaultClip 的话，则会播放 defaultClip 动画</span>
anim.play();

<span class="hljs-comment">// 指定播放 test 动画</span>
anim.play(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 指定从 1s 开始播放 test 动画</span>
anim.play(<span class="hljs-string">'test'</span>, <span class="hljs-number">1</span>);</code></pre><p>Animation 对一个动画进行播放的时候会判断这个动画之前的播放状态来进行下一步操作。
如果动画处于：</p>
<ul class="list">
<li><strong>停止</strong> 状态，则 Animation 会直接重新播放这个动画</li>
<li><strong>暂停</strong> 状态，则 Animation 会恢复动画的播放，并从当前时间继续播放下去</li>
<li><strong>播放</strong> 状态，则 Animation 会先停止这个动画，再重新播放动画</li>
</ul>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);

<span class="hljs-comment">// 播放第一个动画</span>
anim.play(<span class="hljs-string">'position-anim'</span>);

<span class="hljs-comment">// 播放第二个动画</span>
anim.play(<span class="hljs-string">'rotation-anim'</span>);</code></pre><p>Animation 是支持同时播放多个动画的，播放不同的动画并不会影响其他的动画的播放状态，这对于做一些复合动画比较有帮助。</p>
<h3 id="--2">暂停 恢复 停止</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);

anim.play(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 指定暂停 test 动画</span>
anim.pause(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 暂停所有动画</span>
<span class="hljs-comment">// anim.pause();</span>

<span class="hljs-comment">// 指定恢复 test 动画</span>
anim.resume(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 恢复所有动画</span>
<span class="hljs-comment">// anim.resume();</span>

<span class="hljs-comment">// 指定停止 test 动画</span>
anim.stop(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 停止所有动画</span>
<span class="hljs-comment">// anim.stop();</span></code></pre><p><strong>暂停</strong>，<strong>恢复</strong>， <strong>停止</strong> 几个函数的调用比较接近。</p>
<p><strong>暂停</strong> 会暂时停止动画的播放，当 <strong>恢复</strong> 动画的时候，动画会继续从当前时间往下播放。
而 <strong>停止</strong> 则会终止动画的播放，再对这个动画进行播放的时候会重新从开始播放动画。</p>
<h3 id="--3">设置动画的当前时间</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);

anim.play(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 设置 test 动画的当前播放时间为 1s</span>
anim.setCurrentTime(<span class="hljs-number">1</span>, <span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 设置所有动画的当前播放时间为 1s</span>
<span class="hljs-comment">// anim.setCurrentTime(1);</span></code></pre><p>你可以在任何时候对动画设置当前时间，但是动画不会立刻根据设置的时间进行状态的更改，需要在下一个动画的 <strong>update</strong> 中才会根据这个时间重新计算播放状态。</p>
<h2 id="animationstate">AnimationState</h2>
<p><strong>Animation</strong> 只提供了一些简单的控制函数，希望得到更多的动画信息和控制的话，需要使用到 <strong>AnimationState</strong>。</p>
<h3 id="animationstate-">AnimationState 是什么？</h3>
<p>如果说 <strong>AnimationClip</strong> 作为动画数据的承载，那么 <strong>AnimationState</strong> 则是 <strong>AnimationClip</strong> 在运行时的实例，它将动画数据解析为方便程序中做计算的数值。
<strong>Animation</strong> 在播放一个 <strong>AnimationClip</strong> 的时候，会将 <strong>AnimationClip</strong> 解析成 <strong>AnimationState</strong>。
<strong>Animation</strong> 的播放状态实际都是由 <strong>AnimationState</strong> 来计算的，包括动画是否循环，怎么循环，播放速度 等。</p>
<h3 id="-animationstate">获取 AnimationState</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);
<span class="hljs-comment">// play 会返回关联的 AnimationState</span>
<span class="hljs-keyword">var</span> animState = anim.play(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 或是直接获取</span>
<span class="hljs-keyword">var</span> animState = anim.getAnimationState(<span class="hljs-string">'test'</span>);</code></pre><h3 id="--4">获取动画信息</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);
<span class="hljs-keyword">var</span> animState = anim.play(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 获取动画关联的clip</span>
<span class="hljs-keyword">var</span> clip = animState.clip;

<span class="hljs-comment">// 获取动画的名字</span>
<span class="hljs-keyword">var</span> name = animState.name;

<span class="hljs-comment">// 获取动画的播放速度</span>
<span class="hljs-keyword">var</span> speed = animState.speed;

<span class="hljs-comment">// 获取动画的播放总时长</span>
<span class="hljs-keyword">var</span> duration = animState.duration;

<span class="hljs-comment">// 获取动画的播放时间</span>
<span class="hljs-keyword">var</span> time = animState.time;

<span class="hljs-comment">// 获取动画的重复次数</span>
<span class="hljs-keyword">var</span> repeatCount = animState.repeatCount;

<span class="hljs-comment">// 获取动画的循环模式</span>
<span class="hljs-keyword">var</span> wrapMode = animState.wrapMode

<span class="hljs-comment">// 获取动画是否正在播放</span>
<span class="hljs-keyword">var</span> playing = animState.isPlaying;

<span class="hljs-comment">// 获取动画是否已经暂停</span>
<span class="hljs-keyword">var</span> paused = animState.isPaused;

<span class="hljs-comment">// 获取动画的帧率</span>
<span class="hljs-keyword">var</span> frameRate = animState.frameRate;</code></pre><p>从 <strong>AnimationState</strong> 中可以获取到所有动画的信息，你可以利用这些信息来判断需要做哪些事情。</p>
<h3 id="--5">设置动画播放速度</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);
<span class="hljs-keyword">var</span> animState = anim.play(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 使动画播放速度加速</span>
animState.speed = <span class="hljs-number">2</span>;

<span class="hljs-comment">// 使动画播放速度减速</span>
animState.speed = <span class="hljs-number">0.5</span>;</code></pre><p><strong>speed</strong> 值越大速度越快，值越小则速度越慢</p>
<h3 id="--6">设置动画 循环模式 与 循环次数</h3>
<pre class="hljs"><code><span class="hljs-keyword">var</span> anim = <span class="hljs-keyword">this</span>.getComopnent(cc.Animation);
<span class="hljs-keyword">var</span> animState = anim.play(<span class="hljs-string">'test'</span>);

<span class="hljs-comment">// 设置循环模式为 Normal</span>
animState.wrapeMode = cc.WrapMode.Normal;

<span class="hljs-comment">// 设置循环模式为 Loop</span>
animState.wrapeMode = cc.WrapMode.Loop;

<span class="hljs-comment">// 设置动画循环次数为2次</span>
animState.repeatCount = <span class="hljs-number">2</span>;

<span class="hljs-comment">// 设置动画循环次数为无限次</span>
animState.repeatCount = <span class="hljs-literal">Infinity</span>;</code></pre><p><strong>AnimationState</strong> 允许动态设置循环模式，目前提供了多种循环模式，这些循环模式可以从 <strong>cc.WrapMode</strong> 中获取到。
如果动画的循环类型为 <strong>Loop</strong> 类型的话，需要与 <strong>repeatCount</strong> 配合使用才能达到效果。
默认在解析动画剪辑的时候，如果动画循环类型为：</p>
<ul class="list">
<li><strong>Loop</strong> 类型，<strong>repeatCount</strong> 将被设置为 <strong>Infinity</strong>, 即无限循环</li>
<li><strong>Normal</strong> 类型，<strong>repeatCount</strong> 将被设置为 1</li>
</ul>
<h2 id="--7">动画事件</h2>
<p>在动画编辑器里支持可视化编辑帧事件 (如何编辑请参考 <a href="./animation-event.html">这里</a> )，在脚本里书写动画事件的回调也非常简单。
动画事件的回调其实就是一个普通的函数，在动画编辑器里添加的帧事件会映射到动画根节点的组件上。</p>
<h3 id="--8">实例：</h3>
<p>假设在动画的结尾添加了一个帧事件，如下图：
<img src="scripting/animation-event.png" alt="animation event"></p>
<p>那么在脚本中可以这么写：</p>
<pre class="hljs"><code>cc.Class({
    extends: cc.Component,

    onAnimCompleted: <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">num, string</span>) </span>{
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'onAnimCompleted: param1[%s], param2[%s]'</span>, num, string);
    }
});</code></pre><p>将上面的组件加到动画的 <strong>根节点</strong> 上，当动画播放到结尾时，动画系统会自动调用脚本中的 <code>onAnimCompleted</code> 函数。
动画系统会搜索动画根节点中的所有组件，如果组件中有实现动画事件中指定的函数的话，就会对它进行调用，并传入事件中填的参数。</p>
<hr>
<p>继续前往下一章 <a href="../components/index.html">组件参考</a>。</p>
      </article>
    </div>
  </div>
  <script src="../assets/js/anchor.min.js"></script>
  <script>
    anchors.add('article h2, article h3, article h4');
  </script>
  </body>
</html>
