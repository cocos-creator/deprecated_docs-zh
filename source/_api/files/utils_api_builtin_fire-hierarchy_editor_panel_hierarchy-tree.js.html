<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>utils/api/builtin/fire-hierarchy/editor/panel/hierarchy-tree.js - fireball-build</title>
    <link rel="stylesheet" href="../assets/vendor/prettify/prettify-min.css">
    <link rel="stylesheet" href="../assets/css/main.css" id="site_styles">
    <link rel="shortcut icon" type="image/png" href="../assets/favicon.png">
    <script src="../assets/vendor/yui-min.js"></script>
</head>
<body>

<div id="doc">
    <header class="main-header">
        <div class="content">
            <div class="project-title">
                <a href="http://docs-zh.fireball-x.com">
                        <img class="logo" src="http://docs-zh.fireball-x.com/images/logo.png" title="fireball-build">
                </a>
                    <h1 class="project-name">fireball-build</h1> <span class="project-version">0.4.0</span>
                    <p class="description">Fireball is the game engine for the future.</p>
            </div>
            <ul class="jump-links">
                <li><a href="#index" class="index-jump-link">index</a></li>
                <li><a href="#top" class="top-jump-link">top</a></li>
            </ul>
        </div>
    </header>
    <div id="bd" class="main-body">

        <div id="docs-sidebar" class="sidebar apidocs"><div id="api-list">
    <div id="api-tabview" class="tabview">
        <ul class="tabs">
            <li><a href="#api-classes">类型</a></li>
            <li><a href="#api-modules">模组</a></li>
            <li><a href="#api-enums">枚举</a></li>
        </ul>

        <div id="api-tabview-filter">
            <input type="search" id="api-filter" placeholder="输入关键词，过滤API">
        </div>

        <div id="api-tabview-panel">

            <ul id="api-classes" class="apis classes">
                <li>
                    <a class="class" href="../classes/_CallbacksHandler.html">_CallbacksHandler</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/_DeserializeInfo.html">_DeserializeInfo</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/_ObjectFlags.html">_ObjectFlags</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/_Runtime.RenderContext.html">_Runtime.RenderContext</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Animation.html">Animation</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/AnimationNode.html">AnimationNode</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/AnimationNodeBase.html">AnimationNodeBase</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/AnimationState.html">AnimationState</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Array.html">Array</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Asset.html">Asset</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/AssetBundleBase.html">AssetBundleBase</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/AssetLibrary.html">AssetLibrary</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/AtlasAsset.html">AtlasAsset</a>
                    <a href="../modules/Fire.Spine.html" class="api-list-item-module">@Fire.Spine</a>
                </li>
                <li>
                    <a class="class" href="../classes/AudioClip.html">AudioClip</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/AudioSource.html">AudioSource</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/BitmapFont.html">BitmapFont</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/BitmapText.html">BitmapText</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/CallbacksInvoker.html">CallbacksInvoker</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Camera.html">Camera</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Color.html">Color</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Component.html">Component</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/ContentStrategyType.html">ContentStrategyType</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/EmitterMode.html">EmitterMode</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Engine.html">Engine</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Entity.html">Entity</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/EqualToFrame.html">EqualToFrame</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Event.html">Event</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/EventTarget.html">EventTarget</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/FixedHeight.html">FixedHeight</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/FObject.html">FObject</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/FontFlagType.html">FontFlagType</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/HashObject.html">HashObject</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Input.html">Input</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/InputField.html">InputField</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Intersection.html">Intersection</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/KeyboardEvent.html">KeyboardEvent</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/LoadManager.html">LoadManager</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Matrix23.html">Matrix23</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/ModifierKeyStates.html">ModifierKeyStates</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/MouseEvent.html">MouseEvent</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/NoScale.html">NoScale</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/ParticleSystem.html">ParticleSystem</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Path.html">Path</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Playable.html">Playable</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/PositionType.html">PositionType</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Rect.html">Rect</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Renderer.html">Renderer</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Resources.html">Resources</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/ResourcesBundle.html">ResourcesBundle</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Screen.html">Screen</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Screen.ContainerStrategy.html">Screen.ContainerStrategy</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Screen.ContentStrategy.html">Screen.ContentStrategy</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Skeleton.html">Skeleton</a>
                    <a href="../modules/Fire.Spine.html" class="api-list-item-module">@Fire.Spine</a>
                </li>
                <li>
                    <a class="class" href="../classes/SkeletonDataAsset.html">SkeletonDataAsset</a>
                    <a href="../modules/Fire.Spine.html" class="api-list-item-module">@Fire.Spine</a>
                </li>
                <li>
                    <a class="class" href="../classes/SkeletonRenderer.html">SkeletonRenderer</a>
                    <a href="../modules/Fire.Spine.html" class="api-list-item-module">@Fire.Spine</a>
                </li>
                <li>
                    <a class="class" href="../classes/Sprite.html">Sprite</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/SpriteAnimation.html">SpriteAnimation</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/SpriteAnimationClip.html">SpriteAnimationClip</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/SpriteAnimationState.html">SpriteAnimationState</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/SpriteRenderer.html">SpriteRenderer</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Text.html">Text</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Texture.FilterMode.html">Texture.FilterMode</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Texture.Texture.html">Texture.Texture</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Texture.WrapMode.html">Texture.WrapMode</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Time.html">Time</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Transform.html">Transform</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/ValueType.html">ValueType</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a class="class" href="../classes/Vec2.html">Vec2</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
            </ul>

            <ul id="api-modules" class="apis modules">
                <li><a class="module" href="../modules/Editor.html">Editor</a></li>
                <li><a class="module" href="../modules/Fire.html">Fire</a></li>
                <li><a class="module" href="../modules/Fire.JS.html">Fire.JS</a></li>
                <li><a class="module" href="../modules/Fire.Spine.html">Fire.Spine</a></li>
                <li><a class="module" href="../modules/Math.html">Math</a></li>
            </ul>

            <ul id="api-enums" class="apis enums">
                <li>
                    <a href="../enums/Fire.KeyCode.html">Fire.KeyCode</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a href="../enums/FontType.html">FontType</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a href="../enums/ImageType.html">ImageType</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a href="../enums/SpriteAnimationClip.StopAction.html">SpriteAnimationClip.StopAction</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a href="../enums/SpriteAnimationClip.WrapMode.html">SpriteAnimationClip.WrapMode</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a href="../enums/TextAlign.html">TextAlign</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a href="../enums/TextAnchor.html">TextAnchor</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
                <li>
                    <a href="../enums/WrapMode.html">WrapMode</a>
                    <a href="../modules/Fire.html" class="api-list-item-module">@Fire</a>
                </li>
            </ul>
        </div>
    </div>
</div>
</div>

        <div id="docs-main" class="apidocs">
            <div class="content container"><h1 class="file-heading">文件: utils/api/builtin/fire-hierarchy/editor/panel/hierarchy-tree.js</h1>

<div class="file">
    <pre class="code prettyprint linenums">
/**
 * @module Fire
 */
Polymer({
    created: function () {
        this.super();

        // dragging
        this.dragenterCnt = 0;
        this.curDragoverEL = null;
        this.lastDragoverEL = null;
        this.stopMask = false;
        // debug
        hierarchy = this;
    },

    ready: function () {
        this.super();

        // register events
        this.addEventListener( &quot;dragenter&quot;, function (event) {
            ++this.dragenterCnt;
        }, true);

        this.addEventListener( &quot;dragleave&quot;, function (event) {
            --this.dragenterCnt;
            if ( this.dragenterCnt === 0 ) {
                this.resetDragState();
            }
        }, true);

        //
        this.refresh();
    },

    getContextMenuTemplate: function () {
        return [
            // Duplicate
            {
                label: &#x27;Duplicate&#x27;,
                message: &#x27;hierarchy-menu:duplicate&#x27;,
            },

            // =====================
            { type: &#x27;separator&#x27; },

            // Rename
            {
                label: &#x27;Rename&#x27;,
                message: &#x27;hierarchy-menu:rename&#x27;,
            },

            // Delete
            {
                label: &#x27;Delete&#x27;,
                message: &#x27;hierarchy-menu:delete&#x27;,
            },

            // =====================
            { type: &#x27;separator&#x27; },

            {
                label: &#x27;Create Empty&#x27;,
                message: &#x27;hierarchy-menu:create-entity&#x27;,
            },
            {
                label: &#x27;Create Empty Child&#x27;,
                message: &#x27;hierarchy-menu:create-child-entity&#x27;,
            },
            {
                label: &#x27;Create Input Field&#x27;,
                message: &#x27;hierarchy-menu:create-input-field&#x27;,
            },
            {
                label: &#x27;Create Particle System&#x27;,
                message: &#x27;hierarchy-menu:create-particle-system&#x27;,
            },
            {
                label: &#x27;Create Text&#x27;,
                message: &#x27;hierarchy-menu:create-text&#x27;,
            },
            {
                label: &#x27;Create Sprite Animation&#x27;,
                message: &#x27;hierarchy-menu:create-sprite-animation&#x27;,
            },
        ];
    },

    newItem: function ( name, id, parentEL ) {
        var newEL = new HierarchyItem();
        this.initItem(newEL, name, id, parentEL);
        return newEL;
    },

    setItemIndex: function ( id, nextIdInGame ) {
        var el = this.idToItem[id];
        if ( !el ) {
            //Fire.warn( &#x27;Can not find source element: &#x27; + id );
            return;
        }
        if ( nextIdInGame ) {
            var next = this.idToItem[nextIdInGame];
            if ( !next ) {
                //Fire.warn( &#x27;Can not find next element: &#x27; + nextIdInGame );
                return;
            }
            el.parentElement.insertBefore(el, next);
        }
        else {
            el.parentElement.appendChild(el);
        }
    },

    //beginLoad: function () {
    //    // TODO lock
    //    console.time(&#x27;hierarchy-tree:load&#x27;);
    //    // TODO clear
    //},

    //endLoad: function () {
    //    // TODO unlock
    //    console.timeEnd(&#x27;hierarchy-tree:load&#x27;);
    //},

    refresh: function () {
        this.clear();
    },

    highlightBorder: function ( item ) {
        if ( item &amp;&amp; item instanceof HierarchyItem ) {
            var style = this.$.highlightBorder.style;
            style.display = &quot;block&quot;;
            style.left = (item.offsetLeft-2) + &quot;px&quot;;
            style.top = (item.offsetTop-1) + &quot;px&quot;;
            style.width = (item.offsetWidth+4) + &quot;px&quot;;
            style.height = (item.offsetHeight+3) + &quot;px&quot;;
        }
        else {
            this.$.highlightBorder.style.display = &quot;none&quot;;
        }
    },

    highlightInsert: function ( item, position ) {
        if ( item ) {
            var style = this.$.insertLine.style;

            if ( position === &#x27;inside&#x27; ) {
                if ( !item.folded &amp;&amp; item.firstElementChild ) {
                    style.display = &quot;block&quot;;
                    style.top = (item.firstElementChild.offsetTop-1) + &quot;px&quot;;
                    style.left = (item.firstElementChild.offsetLeft-2) + &quot;px&quot;;
                    style.width = (item.firstElementChild.offsetWidth+4) + &quot;px&quot;;
                    style.height = &quot;0px&quot;;
                }
                else {
                    style.display = &quot;none&quot;;
                }
            }
            else {
                style.display = &quot;block&quot;;

                style.left = (item.offsetLeft-2) + &quot;px&quot;;
                style.width = (item.offsetWidth+4) + &quot;px&quot;;

                if ( position === &#x27;before&#x27; )
                    style.top = item.offsetTop + &quot;px&quot;;
                else if ( position === &#x27;after&#x27;  )
                    style.top = (item.offsetTop + item.offsetHeight) + &quot;px&quot;;
                style.height = &quot;0px&quot;;
            }
        }
    },

    cancelHighligting: function () {
        this.$.highlightBorder.style.display = &quot;none&quot;;
        this.$.insertLine.style.display = &quot;none&quot;;
    },

    resetDragState: function () {
        this.cancelHighligting();

        this.curDragoverEL = null;
        this.lastDragoverEL = null;
        this.dragenterCnt = 0;
    },

    moveEntities: function ( targetEL, entities, nextSiblingId ) {
        // TODO: Editor.Selection.filter(entities,&#x27;sorted&#x27;);
        Editor.sendToMainWindow(&#x27;engine:move-entities&#x27;, {
            &#x27;entity-id-list&#x27;: entities,
            &#x27;parent-id&#x27;: targetEL ? targetEL.userId : null,
            &#x27;next-sibling-id&#x27;: nextSiblingId
        });
    },

    createEntityFromContextSelect: function () {
        var contextSelection = Editor.Selection.contextEntities;
        if ( contextSelection.length &gt; 0 ) {
            var targetEL = this.idToItem[contextSelection[0]];
            var parentEL = targetEL.parentElement;
            if ( parentEL &amp;&amp; parentEL instanceof HierarchyItem ) {
                Editor.sendToMainWindow(&#x27;engine:create-entity&#x27;, {
                    &#x27;parent-id&#x27;: parentEL.userId,
                    &#x27;options&#x27;: {
                        &#x27;select-in-hierarchy&#x27;: true
                    }
                });
            }
            else {
                Editor.sendToMainWindow(&#x27;engine:create-entity&#x27;, {
                    &#x27;options&#x27;: {
                        &#x27;select-in-hierarchy&#x27;: true
                    }
                });
            }
        }
        else {
            Editor.sendToMainWindow(&#x27;engine:create-entity&#x27;, {
                &#x27;options&#x27;: {
                    &#x27;select-in-hierarchy&#x27;: true
                }
            });
        }
    },

    createChildEntityFromContextSelect: function () {
        var contextSelection = Editor.Selection.contextEntities;
        if ( contextSelection.length &gt; 0 ) {
            var targetEL = this.idToItem[contextSelection[0]];
            Editor.sendToMainWindow(&#x27;engine:create-entity&#x27;, {
                &#x27;parent-id&#x27;: targetEL.userId,
                &#x27;options&#x27;: {
                    &#x27;select-in-hierarchy&#x27;: true
                }
            });
        }
        else {
            var activeId = Editor.Selection.activeEntityId;
            Editor.sendToMainWindow(&#x27;engine:create-entity&#x27;, {
                &#x27;parent-id&#x27;: activeId,
                &#x27;options&#x27;: {
                    &#x27;select-in-hierarchy&#x27;: true
                }
            });
        }
    },

    createInputField: function () {
        var contextSelection = Editor.Selection.contextEntities;
        if ( contextSelection.length &gt; 0 ) {
            var targetEL = this.idToItem[contextSelection[0]];
            var parentEL = targetEL.parentElement;
            if ( parentEL &amp;&amp; parentEL instanceof HierarchyItem ) {
                Editor.sendToMainWindow(&#x27;engine:create-input-field&#x27;, {
                    &#x27;parent-id&#x27;: parentEL.userId,
                    &#x27;options&#x27;: {
                        &#x27;select-in-hierarchy&#x27;: true
                    }
                });
                return;
            }
        }
        Editor.sendToMainWindow(&#x27;engine:create-input-field&#x27;, {
            &#x27;options&#x27;: {
                &#x27;select-in-hierarchy&#x27;: true
            }
        });
    },

    createParticleSystem: function () {
        var contextSelection = Editor.Selection.contextEntities;
        if ( contextSelection.length &gt; 0 ) {
            var targetEL = this.idToItem[contextSelection[0]];
            var parentEL = targetEL.parentElement;
            if ( parentEL &amp;&amp; parentEL instanceof HierarchyItem ) {
                Editor.sendToMainWindow(&#x27;engine:create-particle-system&#x27;, {
                    &#x27;parent-id&#x27;: parentEL.userId,
                    &#x27;options&#x27;: {
                        &#x27;select-in-hierarchy&#x27;: true
                    }
                });
                return;
            }
        }
        Editor.sendToMainWindow(&#x27;engine:create-particle-system&#x27;, {
            &#x27;options&#x27;: {
                &#x27;select-in-hierarchy&#x27;: true
            }
        });
    },

    createText: function () {
        var contextSelection = Editor.Selection.contextEntities;
        if ( contextSelection.length &gt; 0 ) {
            var targetEL = this.idToItem[contextSelection[0]];
            var parentEL = targetEL.parentElement;
            if ( parentEL &amp;&amp; parentEL instanceof HierarchyItem ) {
                Editor.sendToMainWindow(&#x27;engine:create-text&#x27;, {
                    &#x27;parent-id&#x27;: parentEL.userId,
                    &#x27;options&#x27;: {
                        &#x27;select-in-hierarchy&#x27;: true
                    }
                });
                return;
            }
        }
        Editor.sendToMainWindow(&#x27;engine:create-text&#x27;, {
            &#x27;options&#x27;: {
                &#x27;select-in-hierarchy&#x27;: true
            }
        });
    },

    createSpriteAnimation: function () {
        var contextSelection = Editor.Selection.contextEntities;
        if ( contextSelection.length &gt; 0 ) {
            var targetEL = this.idToItem[contextSelection[0]];
            var parentEL = targetEL.parentElement;
            if ( parentEL &amp;&amp; parentEL instanceof HierarchyItem ) {
                Editor.sendToMainWindow(&#x27;engine:create-sprite-animation&#x27;, {
                    &#x27;parent-id&#x27;: parentEL.userId,
                    &#x27;options&#x27;: {
                        &#x27;select-in-hierarchy&#x27;: true
                    }
                });
                return;
            }
        }
        Editor.sendToMainWindow(&#x27;engine:create-sprite-animation&#x27;, {
            &#x27;options&#x27;: {
                &#x27;select-in-hierarchy&#x27;: true
            }
        });
    },


    renameEntityFromContextSelect: function () {
        var contextSelection = Editor.Selection.contextEntities;
        if ( contextSelection.length &gt; 0 ) {
            var targetEL = this.idToItem[contextSelection[0]];
            this.rename(targetEL);
        }
    },

    deleteEntityFromContextSelect: function () {
        var contextSelection = Editor.Selection.contextEntities;
        Editor.sendToMainWindow(&#x27;engine:delete-entities&#x27;, {
            &#x27;entity-id-list&#x27;: contextSelection
        });
    },

    duplicateEntityFromContextSelect: function () {
        var contextSelection = Editor.Selection.contextEntities;
        var entities = this.getToplevelElements(contextSelection).map(function (element) {
            return element &amp;&amp; element.userId;
        });
        Editor.sendToMainWindow(&#x27;engine:duplicate-entities&#x27;, {
            &#x27;entity-id-list&#x27;: entities
        });
    },

    deleteSelection: function () {
        Editor.sendToMainWindow(&#x27;engine:delete-entities&#x27;, {
            &#x27;entity-id-list&#x27;: Editor.Selection.entities
        });
    },

    duplicateSelection: function () {
        var entities = this.getToplevelElements(Editor.Selection.entities).map(function (element) {
            return element &amp;&amp; element.userId;
        });
        Editor.sendToMainWindow(&#x27;engine:duplicate-entities&#x27;, {
            &#x27;entity-id-list&#x27;: entities
        });
    },

    select: function ( element ) {
        Editor.Selection.selectEntity(element.userId, true, true);
    },

    clearSelect: function () {
        Editor.Selection.clearEntity();
        this.activeElement = null;
        this.shiftStartElement = null;
    },

    selectingAction: function (event) {
        event.stopPropagation();
        this.focus();

        var shiftStartEL = this.shiftStartElement;
        this.shiftStartElement = null;

        if ( event.detail.shift ) {
            if ( shiftStartEL === null ) {
                shiftStartEL = this.activeElement;
            }

            this.shiftStartElement = shiftStartEL;

            var el = this.shiftStartElement;
            var userIds = [];

            if ( shiftStartEL !== event.target ) {
                if ( this.shiftStartElement.offsetTop &lt; event.target.offsetTop ) {
                    while ( el !== event.target ) {
                        userIds.push(el.userId);
                        el = this.nextItem(el);
                    }
                }
                else {
                    while ( el !== event.target ) {
                        userIds.push(el.userId);
                        el = this.prevItem(el);
                    }
                }
            }
            userIds.push(event.target.userId);
            Editor.Selection.selectEntity(userIds, true, false);
        }
        else if ( event.detail.toggle ) {
            if ( event.target.selected ) {
                Editor.Selection.unselectEntity(event.target.userId, false);
            }
            else {
                Editor.Selection.selectEntity(event.target.userId, false, false);
            }
        }
        else {
            // if target already selected, do not unselect others
            if ( !event.target.selected ) {
                Editor.Selection.selectEntity(event.target.userId, true, false);
            }
        }
    },

    selectAction: function (event) {
        event.stopPropagation();

        if ( event.detail.shift ) {
            Editor.Selection.confirm();
        }
        else if ( event.detail.toggle ) {
            Editor.Selection.confirm();
        }
        else {
            Editor.Selection.selectEntity(event.target.userId, true);
        }
    },

    renameConfirmAction: function (event) {
        event.stopPropagation();

        var renamingEL = this.$.nameInput.renamingEL;

        this.$.nameInput.style.display = &#x27;none&#x27;;
        this.$.content.appendChild(this.$.nameInput);
        this.$.nameInput.renamingEL = null;

        // NOTE: the rename confirm will invoke focusoutAction
        window.requestAnimationFrame( function () {
            this.focus();
        }.bind(this));

        renamingEL._renaming = false;

        // TODO: pull up to view ?
        Editor.sendToMainWindow(&#x27;engine:rename-entity&#x27;, {
            id: renamingEL.userId,
            name: event.target.value
        } );
    },

    openAction: function (event) {
        if ( event.target instanceof HierarchyItem ) {
            // TODO: align scene view to target
        }
        event.stopPropagation();
    },

    contextmenuAction: function (event) {
        event.preventDefault();
        event.stopPropagation();

        var Remote = require(&#x27;remote&#x27;);
        Remote.getCurrentWindow().focus();

        this.resetDragState();

        //
        var curContextID = null;
        if ( event.target instanceof HierarchyItem ) {
            curContextID = event.target.userId;
        }

        Editor.Selection.setContextEntity(curContextID);

        Editor.Menu.popup(this.getContextMenuTemplate());
    },

    keydownAction: function (event) {
        this.super([event]);
        if (event.cancelBubble) {
            return;
        }

        switch ( event.which ) {
            // delete (Windows)
            case 46:
                this.deleteSelection();
                event.stopPropagation();
            break;

            // command + delete (Mac)
            case 8:
                if ( event.metaKey ) {
                    this.deleteSelection();
                }
                event.stopPropagation();
            break;
        }
    },

    dragstartAction: function ( event ) {
        event.stopPropagation();

        EditorUI.DragDrop.start( event.dataTransfer, &#x27;move&#x27;, &#x27;entity&#x27;, Editor.Selection.entities.map( function (item) {
            var ent = Editor.getInstanceById(item);
            return { name: ent.name, id: item };
        }) );
    },

    dragendAction: function (event) {
        EditorUI.DragDrop.end();

        this.resetDragState();
        Editor.Selection.cancel();
    },

    dragoverAction: function (event) {
        var dragType = EditorUI.DragDrop.type(event.dataTransfer);
        if ( dragType !== &quot;entity&quot; &amp;&amp; dragType !== &quot;asset&quot; ) {
            EditorUI.DragDrop.allowDrop( event.dataTransfer, false );
            return;
        }

        //
        event.preventDefault();
        event.stopPropagation();

        //
        if ( event.target ) {
            this.lastDragoverEL = this.curDragoverEL;
            var position;
            var bounding = this.getBoundingClientRect();
            var offsetY = event.clientY - bounding.top + this.scrollTop;
            var target = event.target;

            //
            if ( target !== this.lastDragoverEL ) {
                if ( target === this ) {
                    if ( offsetY &lt;= this.firstElementChild.offsetTop ) {
                        target = this.firstElementChild;
                    }
                    else {
                        target = this.lastElementChild;
                    }
                }
                this.curDragoverEL = target;
            }

            // highlight insertion
            if ( offsetY &lt;= (target.offsetTop + target.offsetHeight * 0.3) )
                position = &#x27;before&#x27;;
            else if ( offsetY &gt;= (target.offsetTop + target.offsetHeight * 0.7) )
                position = &#x27;after&#x27;;
            else
                position = &#x27;inside&#x27;;

            if ( position === &#x27;inside&#x27; ) {
                this.highlightBorder( target );
            }
            else {
                this.highlightBorder( target.parentElement );
            }
            this.highlightInsert( target, position );

            //
            EditorUI.DragDrop.allowDrop(event.dataTransfer, true);
        }

        //
        var dropEffect = &quot;none&quot;;
        if ( dragType === &quot;asset&quot; ) {
            dropEffect = &quot;copy&quot;;
        }
        else if ( dragType === &quot;entity&quot; ) {
            dropEffect = &quot;move&quot;;
        }
        EditorUI.DragDrop.updateDropEffect(event.dataTransfer, dropEffect);
    },

    dropAction: function ( event ) {
        var dragType = EditorUI.DragDrop.type(event.dataTransfer);
        if ( dragType !== &#x27;asset&#x27; &amp;&amp; dragType !== &#x27;entity&#x27; )
            return;

        event.preventDefault();
        event.stopPropagation();

        var items = EditorUI.DragDrop.drop(event.dataTransfer);

        this.resetDragState();
        Editor.Selection.cancel();

        if ( items.length &gt; 0 ) {
            // get next sibliing id
            var hoverTarget = event.target;
            var targetEL = null;
            var nextSiblingId = null;
            var bounding = this.getBoundingClientRect();
            var offsetY = event.clientY - bounding.top + this.scrollTop;

            if ( hoverTarget === this ) {
                targetEL = null;
                if ( this.firstElementChild ) {
                    if ( offsetY &lt;= this.firstElementChild.offsetTop ) {
                        nextSiblingId = this.firstElementChild.userId;
                    }
                }
            }
            else {
                if ( offsetY &lt;= (hoverTarget.offsetTop + hoverTarget.offsetHeight * 0.3) ) {
                    nextSiblingId = hoverTarget.userId;
                    targetEL = hoverTarget.parentElement;
                }
                else if ( offsetY &gt;= (hoverTarget.offsetTop + hoverTarget.offsetHeight * 0.7) ) {
                    if ( hoverTarget.nextElementSibling ) {
                        nextSiblingId = hoverTarget.nextElementSibling.userId;
                    }
                    else {
                        nextSiblingId = null;
                    }
                    targetEL = hoverTarget.parentElement;
                }
                else {
                    nextSiblingId = null;
                    targetEL = hoverTarget;
                    if ( targetEL.firstElementChild ) {
                        nextSiblingId = targetEL.firstElementChild.userId;
                    }
                }
            }

            // if target is root, set it to null
            if ( targetEL === this ) {
                targetEL = null;
            }

            // process
            if ( dragType === &#x27;entity&#x27; ) {
                this.moveEntities( targetEL, items, nextSiblingId );
            }
            else if ( dragType === &#x27;asset&#x27; ) {
                var parentEnt = null;
                if ( targetEL )
                    parentEnt = Editor.getInstanceById(targetEL.userId);

                Editor.Selection.clearEntity();
                var onload = function ( err, asset ) {
                    if ( asset &amp;&amp; asset.createEntity ) {
                        asset.createEntity( function ( ent ) {
                            ent.parent = parentEnt;
                            ent.transform.position = new Fire.Vec2(0,0);
                            Editor.Selection.selectEntity( ent.id, false, true );
                            Editor.sendToMainWindow( &#x27;scene:dirty&#x27;, ent.id );
                            Editor.sendToWindows( &#x27;scene:repaint&#x27; );
                            Fire.AssetLibrary.cacheAsset( asset );
                        }.bind(this) );
                    }
                }.bind(this);

                for ( var i = 0; i &lt; items.length; ++i ) {
                    Fire.AssetLibrary.loadAssetInEditor( items[i], onload );
                }
            }
        }
    },

    highlightElement: function (ele) {
        var element = ele;
        var topMask = document.createElement(&#x27;div&#x27;);
        var bottomMask = document.createElement(&#x27;div&#x27;);
        var centerMask = document.createElement(&#x27;div&#x27;);

        topMask.style.pointerEvents = &quot;none&quot;;
        topMask.style.position = &#x27;absolute&#x27;;
        topMask.style.background = &#x27;black&#x27;;
        topMask.style.opacity = 0.5;
        topMask.style.zIndex = 999;
        topMask.setAttribute(&#x27;name&#x27;,&#x27;EDIT_MASK&#x27;);

        bottomMask.style.background = &#x27;black&#x27;;
        bottomMask.style.opacity = 0.5;
        bottomMask.style.zIndex = 999;
        bottomMask.style.position = &#x27;absolute&#x27;;
        bottomMask.style.pointerEvents = &quot;none&quot;;
        bottomMask.setAttribute(&#x27;name&#x27;,&#x27;EDIT_MASK&#x27;);

        centerMask.style.zIndex = 999;
        centerMask.style.position = &#x27;absolute&#x27;;
        centerMask.style.pointerEvents = &quot;none&quot;;
        centerMask.style.border = &#x27;1px dotted white&#x27;;
        centerMask.setAttribute(&#x27;name&#x27;,&#x27;EDIT_MASK&#x27;);

        document.body.appendChild(topMask);
        document.body.appendChild(bottomMask);
        document.body.appendChild(centerMask);

        this.stopMask = false;
        this.updateMask(topMask,centerMask,bottomMask,element);
    },

    updateMask: function (topMask,centerMask,bottomMask,element) {
        if ( this.stopMask ) {
            return;
        }

        window.requestAnimationFrame( function() {
            var rootRect = this.getBoundingClientRect();
            var selectRect = element.getBoundingClientRect();
            topMask.style.width = rootRect.width;
            topMask.style.height = selectRect.top - rootRect.top;
            topMask.style.top = rootRect.top;
            topMask.style.left = rootRect.left;

            bottomMask.style.width = rootRect.width;
            bottomMask.style.top = selectRect.top + selectRect.height;
            bottomMask.style.height = rootRect.height - selectRect.height - (selectRect.top - rootRect.top);
            bottomMask.style.left = rootRect.left;

            centerMask.style.top = selectRect.top -1;
            centerMask.style.left = rootRect.left+1;
            centerMask.style.width = rootRect.width-2;
            centerMask.style.height = selectRect.height -2;
            this.updateMask(topMask,centerMask,bottomMask,element);
        }.bind(this) );
    },

    clearMask: function () {
        var count = document.getElementsByName(&#x27;EDIT_MASK&#x27;).length;
        for (var i = 0; i &lt; count; i++) {
            var child = document.getElementsByName(&#x27;EDIT_MASK&#x27;)[0];
            document.body.removeChild(child);
        }

        this.stopMask = true;
    },

});

    </pre>
</div>
</div>
        </div>

    </div>
</div>
<script src="../assets/vendor/prettify/prettify-min.js"></script>
<script>prettyPrint();</script>
<script src="../assets/vendor/jquery.min.js"></script>
<script src="../assets/js/jquery-offscreen-trigger.js"></script>
<script src="../assets/js/yui-prettify.js"></script>
<script src="../assets/../api.js"></script>
<script src="../assets/js/api-filter.js"></script>
<script src="../assets/js/api-list.js"></script>
<script src="../assets/js/api-search.js"></script>
<script src="../assets/js/apidocs.js"></script>
</body>
</html>
